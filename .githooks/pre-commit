#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Only run if staged changes are in docs/
if ! git diff --cached --name-only --diff-filter=ACMR | grep -q '^docs/'; then
  exit 0
fi

# Check for Ruby
if ! command -v ruby >/dev/null 2>&1; then
  echo "[pre-commit] WARNING: Ruby not found. Skipping search index generation."
  exit 0
fi

# Check for Bundler
if ! command -v bundle >/dev/null 2>&1; then
  echo "[pre-commit] Bundler not found â€” installing..."
  gem install bundler --no-document || {
    echo "[pre-commit] ERROR: Failed to install Bundler."
    exit 1
  }
fi

# Ensure bundle install is run if needed
if [ -f "Gemfile" ]; then
  if ! bundle check >/dev/null 2>&1; then
    echo "[pre-commit] Installing Ruby gems..."
    bundle install --quiet
  fi
  BUNDLE="bundle exec"
else
  BUNDLE=""
fi

echo "[pre-commit] Docs changed â€” regenerating search index..."
if ! (cd docs && $BUNDLE just-the-docs rake search:init); then
  echo "[pre-commit] ERROR: Failed to generate search index."
  exit 1
fi

# Stage generated files
git add docs/assets/js/search-data.json 2>/dev/null || true
git add docs/assets/js/*.json 2>/dev/null || true

echo "[pre-commit] Search index generated and staged."

